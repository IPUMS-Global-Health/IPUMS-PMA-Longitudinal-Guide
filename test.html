<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width">
<meta property="og:title" content="test" />






<meta name="description" content="test">

<script id="pandoc-meta" type="application/json">
{"newpage_html_class":"page-break-after","cap-location":"margin","toc-title":"Contents","lof":false,"toc":true,"paged-footnotes":true,"css":["css/layout.css","css/fix-pagedown.css","css/fonts.css"],"lot":false,"output":{"pagedown::html_paged":{"self_contained":false,"toc":true}},"title":"test"}
</script>

<title>test</title>


<link href="test_files/paged-0.19/css/default-fonts.css" rel="stylesheet" />
<link href="test_files/paged-0.19/css/default-page.css" rel="stylesheet" />
<link href="test_files/paged-0.19/css/default.css" rel="stylesheet" />
<script src="test_files/paged-0.19/js/config.js"></script>
<script src="test_files/paged-0.19/js/paged.js"></script>
<script src="test_files/paged-0.19/js/hooks.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="css/layout.css" type="text/css" />
<link rel="stylesheet" href="css/fix-pagedown.css" type="text/css" />
<link rel="stylesheet" href="css/fonts.css" type="text/css" />

</head>

<body>

<div class="running-h1-title"></div>

<div class="running-h2-title"></div>



<div class="front-page">
<div id="header" class="title-page">
<h1 class="title">test</h1>
</div>
</div>

<div class="front-matter-container">
<div id="TOC" class="level1 toc front-matter">
<h1 class="toc-title">Contents</h1>
<ul>
<li><a href="#advanced-data-visualization"><span class="toc-section-number">1</span> Advanced Data Visualization</a>
<ul>
<li><a href="#chapter-setup"><span class="toc-section-number">1.1</span> Chapter Setup</a></li>
<li><a href="#grouped-bar-charts"><span class="toc-section-number">1.2</span> Grouped Bar Charts</a></li>
<li><a href="#heatmaps"><span class="toc-section-number">1.3</span> Heatmaps</a></li>
<li><a href="#alluvial-plots"><span class="toc-section-number">1.4</span> Alluvial plots</a></li>
</ul></li>
</ul>
</div>
</div>

<div class="main">
<div id="advanced-data-visualization" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Advanced Data Visualization</h1>
<p>In Chapter 4, we demonstrated how to calculate key family planning indicators for PMA panel surveys. We also created simple bar charts to help readers compare confidence intervals for each population estimate.</p>
<p>Chapter 5 digs into some of the other data visualization tools that are commonly used for two-phase panel data: this will include color-coded crosstabs - or <strong>heatmaps</strong> - and <strong>alluvial plots</strong> resembling those shown in the PMA Longitudinal Brief for each survey.</p>
<p>R users can build heatmaps with the same <a href="https://ggplot2.tidyverse.org">ggplot2</a> package featured in Chapter 4, but alluvial plots are a bit more challenging. To make things easier, we’ll build ours with <a href="https://corybrunson.github.io/ggalluvial">ggalluvial</a>, an extension package for <a href="https://ggplot2.tidyverse.org">ggplot2</a> that includes tools designed specifically for alluvial plots.<span id="fn1" class="footnote" data-pagedown-footnote-number="1" style="white-space: pre-line;">© Cory Brunson et al. (GPL-3)</span></p>
<div id="chapter-setup" class="section level2" number="1.1">
<h2><span class="header-section-number">1.1</span> Chapter Setup</h2>
<p>In addition to <a href="https://corybrunson.github.io/ggalluvial">ggalluvial</a>, we’ll also load three packages featured throughout this manual: <a href="https://tidyverse.tidyverse.org/">tidyverse</a>, <a href="https://tech.popdata.org/ipumsr/">ipumsr</a>, and <a href="http://gdfe.co/srvyr">srvyr</a>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ipumsr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(srvyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggalluvial)</span></code></pre></div>
<p>This chapter features the same data extract showcased in Chapter 4, which includes all six of the available samples. It is organized in <strong>wide format</strong> with only <strong>Female Respondents</strong> selected. This chapter focuses on the following variables included in that extract:</p>
<ul>
<li><a href="https://pma.ipums.org/pma-action/variables/RESULTFQ#codes_section">RESULTFQ</a> - Result of female questionnaire</li>
<li><a href="https://pma.ipums.org/pma-action/variables/PANELWEIGHT#codes_section">PANELWEIGHT</a> - Phase 2 female panel weight</li>
<li><a href="https://pma.ipums.org/pma-action/variables/RESIDENT#codes_section">RESIDENT</a> - Household residence / membership</li>
<li><a href="https://pma.ipums.org/pma-action/variables/PREGNANT#codes_section">PREGNANT</a> - Pregnancy status</li>
<li><a href="https://pma.ipums.org/pma-action/variables/GEOCD#codes_section">GEOCD</a> - Province, DRC</li>
<li><a href="https://pma.ipums.org/pma-action/variables/GEONG#codes_section">GEONG</a> - State, Nigeria</li>
<li><a href="https://pma.ipums.org/pma-action/variables/CP#codes_section">CP</a> - Contraceptive user</li>
<li><a href="https://pma.ipums.org/pma-action/variables/COUNTRY#codes_section">COUNTRY</a> - PMA country (preselected)</li>
<li><a href="https://pma.ipums.org/pma-action/variables/EAID#codes_section">EAID</a> - Enumeration area (preselected)</li>
</ul>
<p>Recall that our analysis in Chapter 4 concerned only <em>de facto</em> panel members who completed all or part of the Female Questionnaire in both Phase 1 and Phase 2. We also excluded women who are marked “NIU (not in universe)” for a key question concerning current contraceptive use (<a href="https://pma.ipums.org/pma-action/variables/CP#codes_section">CP</a>). As a reminder, you can load the extract into R and select relevant cases like so:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import the data extract and metadata files</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read_ipums_micro</span>(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">ddi =</span> <span class="st">&quot;data/pma_00106.xml&quot;</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="st">&quot;data/pma_00106.dat.gz&quot;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># inclusion criteria for analysis</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    RESULTFQ_2 <span class="sc">==</span> <span class="dv">1</span>,  <span class="co"># must have completed Phase 1 FQ</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    RESIDENT_1 <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">11</span>, <span class="dv">22</span>) <span class="sc">&amp;</span> <span class="co"># must be de facto population (both phases)</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>      RESIDENT_2 <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">11</span>, <span class="dv">22</span>),</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    CP_1 <span class="sc">&lt;</span> <span class="dv">90</span> <span class="sc">&amp;</span> CP_2 <span class="sc">&lt;</span> <span class="dv">90</span> <span class="co"># must answer &quot;current FP use&quot; question (both phases)</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  ) </span></code></pre></div>
<div class="page-break-after"></div>
<p>Additionally, we will reference four variables created in Chapter 4:</p>
<ul>
<li><code>POP</code> - Population of interest</li>
<li><code>STRATA_RECODE</code> - Sample strata (adjusted to include DRC samples)</li>
<li><code>FPSTATUS_1</code> - Pregnant, using contraception, or using no contraception at Phase 1</li>
<li><code>FPSTATUS_2</code> - Pregnant, using contraception, or using no contraception at Phase 2</li>
</ul>
<p>These variables were created like so:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># custom variables: `POP` and `FPSTATUS`</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Population of interest (country + region, where applicable)</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">POP =</span> <span class="fu">case_when</span>(</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(GEOCD) <span class="sc">~</span> <span class="fu">paste</span>(<span class="st">&quot;DRC -&quot;</span>, <span class="fu">as_factor</span>(GEOCD)),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(GEONG) <span class="sc">~</span> <span class="fu">paste</span>(<span class="st">&quot;Nigeria -&quot;</span>, <span class="fu">as_factor</span>(GEONG)),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">as_factor</span>(COUNTRY) <span class="sc">%&gt;%</span> <span class="fu">as.character</span>()</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># strata: includes placeholder values for DRC regions </span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">STRATA_RECODE =</span> <span class="fu">if_else</span>(</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(GEOCD), </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.numeric</span>(STRATA_1), </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.numeric</span>(GEOCD)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Family planning use-status at Phase 1 </span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">FPSTATUS_1 =</span> <span class="fu">case_when</span>(</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>      PREGNANT_1 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">&quot;Pregnant&quot;</span>,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>      CP_1 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">&quot;Using FP&quot;</span>,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>      CP_1 <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">&quot;Not Using FP&quot;</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    ), </span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Family planning use-status at Phase 2 </span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">FPSTATUS_2 =</span> <span class="fu">case_when</span>(</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>      PREGNANT_2 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">&quot;Pregnant&quot;</span>,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>      CP_2 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">&quot;Using FP&quot;</span>,</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>      CP_2 <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">&quot;Not Using FP&quot;</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create factors to control order of display in graphics output </span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(FPSTATUS_1, FPSTATUS_2),</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span>.x <span class="sc">%&gt;%</span> <span class="fu">fct_relevel</span>(<span class="st">&quot;Pregnant&quot;</span>, <span class="st">&quot;Not Using FP&quot;</span>, <span class="st">&quot;Using FP&quot;</span>)</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
</div>
<div id="grouped-bar-charts" class="section level2" number="1.2">
<h2><span class="header-section-number">1.2</span> Grouped Bar Charts</h2>
<p>Now let’s revisit the <strong>grouped bar chart</strong> we made to compare <code>FPSTATUS_1</code> and <code>FPSTATUS_2</code> for each population <code>POP</code> in Chapter 4. We made this chart in basically two steps.</p>
<p>First, we used <a href="http://gdfe.co/srvyr/index.html">srvyr</a> to build a summary table that incorporates survey weights from <a href="https://pma.ipums.org/pma-action/variables/PANELWEIGHT#codes_section">PANELWEIGHT</a> and generates a 95% confidence interval for each estimate. We used <a href="https://pma.ipums.org/pma-action/variables/EAID#codes_section">EAID_1</a> to generate the cluster-robust standard errors underlying each confidence interval, and we stratified standard error estimation by <code>STRATA_RECODE</code>.</p>
<p>Notice that we <a href="http://gdfe.co/srvyr/reference/group_by.html">group_by</a> <code>FPSTATUS_1</code> and <code>FPSTATUS_2</code> here. When we do this, <a href="http://gdfe.co/srvyr/reference/survey_mean.html">survey_mean</a> estimates the proportion of outcomes represented by the variable that appears <em>last</em>, which is <code>FPSTATUS_2</code>. The proportions sum to <code>1.0</code> for each combination of <code>POP</code> and <code>FPSTATUS_1</code>: in other words, we obtain the proportion of <code>FPSTATUS_2</code> <em>on the condition</em> that women from a given <code>POP</code> held a particular status represented by <code>FPSTATUS_1</code>. For this reason, this is known as a <strong>conditional distribution</strong>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>status_tbl <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(POP) <span class="sc">%&gt;%</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">&quot;keep&quot;</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cur_data</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as_survey_design</span>(<span class="at">weight =</span> PANELWEIGHT, <span class="at">id =</span> EAID_1, <span class="at">strata =</span> STRATA_RECODE) <span class="sc">%&gt;%</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(FPSTATUS_1, FPSTATUS_2) <span class="sc">%&gt;%</span> </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="fu">survey_mean</span>(<span class="at">prop =</span> <span class="cn">TRUE</span>, <span class="at">prop_method =</span> <span class="st">&quot;logit&quot;</span>, <span class="at">vartype =</span> <span class="st">&quot;ci&quot;</span>))</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>status_tbl</span></code></pre></div>
<pre><code># A tibble: 54 × 6
# Groups:   POP [6]
   POP            FPSTATUS_1   FPSTATUS_2     coef `_low` `_upp`
   &lt;chr&gt;          &lt;fct&gt;        &lt;fct&gt;         &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
 1 Burkina Faso   Pregnant     Pregnant     0.0302 0.0137 0.0652
 2 Burkina Faso   Pregnant     Not Using FP 0.568  0.491  0.642 
 3 Burkina Faso   Pregnant     Using FP     0.401  0.329  0.478 
 4 Burkina Faso   Not Using FP Pregnant     0.0779 0.0651 0.0929
 5 Burkina Faso   Not Using FP Not Using FP 0.739  0.711  0.765 
 6 Burkina Faso   Not Using FP Using FP     0.183  0.158  0.211 
 7 Burkina Faso   Using FP     Pregnant     0.0993 0.0815 0.121 
 8 Burkina Faso   Using FP     Not Using FP 0.248  0.213  0.287 
 9 Burkina Faso   Using FP     Using FP     0.653  0.609  0.694 
10 DRC - Kinshasa Pregnant     Pregnant     0.0367 0.0140 0.0930
# … with 44 more rows</code></pre>
<div class="page-break-after"></div>
<p>The <strong>grouped bar chart</strong> made in Chapter 4 plots the estimated values in <code>coef</code> together with the confidence interval represented by <code>_low</code> and <code>_upp</code>. This chart is useful because it packs a lot of information into a single, reader-friendly graphic. However, we also mentioned at the end of Chapter 4 that it has some considerable drawbacks. Most importantly, we weren’t able to include information from the <strong>marginal distribution</strong> in each phase.</p>
<p><img src="test_files/figure-html/unnamed-chunk-6-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p>A <strong>marginal distribution</strong> for <code>FPSTATUS_1</code> would indicate the likelihood that a woman began the survey period pregnant, using family planning, or not using family planning. Likewise the marginal distribution for <code>FPSTATUS_2</code> estimates the likelihood that a woman would hold any such status at Phase 2, <em>independently of</em> her status at Phase 1. We call these distributions “marginal” because they’re usually included in the row or column margins of a crosstab.</p>
</div>
<div id="heatmaps" class="section level2" number="1.3">
<h2><span class="header-section-number">1.3</span> Heatmaps</h2>
<aside>
For consistency, <code>pma_heatmap</code> uses the same color scheme shown in the first figure of each PMA report.
</aside>
<p>Let’s return to <code>status_tbl</code>, but this time we’ll plot it as a crosstab with <code>color</code> and <code>alpha</code> (transparency) aesthetics. This type of crosstab is usually called a <strong>heatmap</strong>. First, we’ll wrap a few cosmetic layout options into a custom function we’ll call <code>pma_heatmap</code>. Feel free to create your own theme, but we include the code used to produce ours below (you’ll need the <a href="https://github.com/yixuan/showtext">showtext</a> package to load a custom font like “cabrito”, or you can omit that part to use the R default font).</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>pma_heatmap <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="cn">NULL</span>,     <span class="co"># an optional title </span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="cn">NULL</span>,  <span class="co"># an optional subtitle </span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">xaxis =</span> <span class="cn">NULL</span>,     <span class="co"># an optional label for the x-axis (displayed below)</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">yaxis =</span> <span class="cn">NULL</span>      <span class="co"># an optional label for the y-axis (displayed right)</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>){</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  components <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">%+replace%</span> <span class="fu">theme</span>(</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">family =</span> <span class="st">&quot;cabrito&quot;</span>, <span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>, <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">10</span>, <span class="at">b =</span> <span class="dv">10</span>)),</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">strip.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>, <span class="at">angle =</span> <span class="dv">0</span>),</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">strip.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">0</span>, <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">r =</span> <span class="dv">10</span>)),</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title.y.right =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">0</span>, <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">l =</span> <span class="dv">10</span>)),</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title.x.bottom =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">20</span>)),</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">22</span>, <span class="at">color =</span> <span class="st">&quot;#00263A&quot;</span>, </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>                                <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">b =</span> <span class="dv">5</span>)),  </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">b =</span> <span class="dv">10</span>)),</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.spacing =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">&quot;lines&quot;</span>),</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> title, <span class="at">subtitle =</span> subtitle, <span class="at">x =</span> xaxis, <span class="at">y =</span> <span class="fu">str_wrap</span>(yaxis, <span class="dv">10</span>)),</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;Pregnant&quot;</span> <span class="ot">=</span> <span class="st">&quot;#B4B3B3&quot;</span>, <span class="st">&quot;Not Using FP&quot;</span> <span class="ot">=</span> <span class="st">&quot;#4E4F71&quot;</span>, <span class="st">&quot;Using FP&quot;</span> <span class="ot">=</span> <span class="st">&quot;#EFD372&quot;</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    )),</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;white&quot;</span>)),</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_discrete</span>(<span class="at">position =</span> <span class="st">&quot;right&quot;</span>, <span class="at">limits =</span> rev)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The plot is built with rectangles from <a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a> and text labels from <a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a>. Then, we tell <a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a> to use one <code>fill</code> color for each type of response in <code>FPSTATUS_1</code>: this makes it easy for the reader to see that the totals in each tile sum to 100% in columns (not rows). The <code>alpha</code> aesthetic uses the value in <code>coef</code> to control the transparency of each color (by default, our minimum value <code>0</code> would be 100% transparent).</p>
<div class="page-break-after"></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>status_tbl <span class="sc">%&gt;%</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> FPSTATUS_1, <span class="at">y =</span> FPSTATUS_2)) <span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> FPSTATUS_1, <span class="at">alpha =</span> coef)) <span class="sc">+</span> </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(coef, <span class="dv">1</span>),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> coef <span class="sc">&gt;</span> <span class="fl">0.5</span> <span class="sc">&amp;</span> FPSTATUS_1 <span class="sc">==</span> <span class="st">&quot;Not Using FP&quot;</span> <span class="co"># white vs black text</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span> </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>POP, <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">scales =</span> <span class="st">&quot;fixed&quot;</span>) <span class="sc">+</span> </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pma_heatmap</span>(</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;CHANGE IN CONTRACEPTIVE USE OR NON-USE&quot;</span>,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Percent women age 15-49 who changed contraceptive use status&quot;</span>,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">xaxis =</span> <span class="st">&quot;Phase 1 Status&quot;</span>,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">yaxis =</span> <span class="st">&quot;Phase 2 Status&quot;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  ) </span></code></pre></div>
<p><img src="test_files/figure-html/unnamed-chunk-8-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p>The nice thing about this heatmap layout is that - compared with our bar chart - it’s much easier to include data from the marginal distribution of <code>FPSTATUS_1</code> and <code>FPSTATUS_2</code>. To do so, we’ll first need to add them to <code>status_tbl</code>.</p>
<div class="page-break-after"></div>
<aside>
We use <a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a>, but both <a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a> and <a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join</a> would work equally well in this case.
</aside>
<p>First, we use <code>group_by(FPSTATUS_1)</code> to make the column margins and <a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">join</a> them to <code>status_tbl</code>. (Note that we set <code>vartype = NULL</code> because we won’t be able to include confidence intervals on our heatmap.)</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>status_tbl <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(POP) <span class="sc">%&gt;%</span> </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cur_data</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as_survey_design</span>(<span class="at">weight =</span> PANELWEIGHT, <span class="at">id =</span> EAID_1, <span class="at">strata =</span> STRATA_RECODE) <span class="sc">%&gt;%</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(FPSTATUS_1) <span class="sc">%&gt;%</span> </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">cols =</span> <span class="fu">survey_mean</span>(<span class="at">prop =</span> <span class="cn">TRUE</span>, <span class="at">prop_method =</span> <span class="st">&quot;logit&quot;</span>, <span class="at">vartype =</span> <span class="cn">NULL</span>))</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(status_tbl, ., <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;POP&quot;</span>, <span class="st">&quot;FPSTATUS_1&quot;</span>))</span></code></pre></div>
<p>Next, we use <code>group_by(FPSTATUS_2)</code> to add row margins to <code>status_tbl</code>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>status_tbl <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(POP) <span class="sc">%&gt;%</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cur_data</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as_survey_design</span>(<span class="at">weight =</span> PANELWEIGHT, <span class="at">id =</span> EAID_1, <span class="at">strata =</span> STRATA_RECODE) <span class="sc">%&gt;%</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(FPSTATUS_2) <span class="sc">%&gt;%</span> </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">rows =</span> <span class="fu">survey_mean</span>(<span class="at">prop =</span> <span class="cn">TRUE</span>, <span class="at">prop_method =</span> <span class="st">&quot;logit&quot;</span>, <span class="at">vartype =</span> <span class="cn">NULL</span>))</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(status_tbl, ., <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;POP&quot;</span>, <span class="st">&quot;FPSTATUS_2&quot;</span>))</span></code></pre></div>
<p>The column margins now appear in <code>cols</code>, while the row margins appear in <code>rows</code>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>status_tbl</span></code></pre></div>
<pre><code># A tibble: 54 × 8
# Groups:   POP [6]
   POP            FPSTATUS_1   FPSTATUS_2     coef `_low` `_upp`   cols   rows
   &lt;chr&gt;          &lt;fct&gt;        &lt;fct&gt;         &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
 1 Burkina Faso   Pregnant     Pregnant     0.0302 0.0137 0.0652 0.0879 0.0799
 2 Burkina Faso   Pregnant     Not Using FP 0.568  0.491  0.642  0.0879 0.583 
 3 Burkina Faso   Pregnant     Using FP     0.401  0.329  0.478  0.0879 0.337 
 4 Burkina Faso   Not Using FP Pregnant     0.0779 0.0651 0.0929 0.624  0.0799
 5 Burkina Faso   Not Using FP Not Using FP 0.739  0.711  0.765  0.624  0.583 
 6 Burkina Faso   Not Using FP Using FP     0.183  0.158  0.211  0.624  0.337 
 7 Burkina Faso   Using FP     Pregnant     0.0993 0.0815 0.121  0.288  0.0799
 8 Burkina Faso   Using FP     Not Using FP 0.248  0.213  0.287  0.288  0.583 
 9 Burkina Faso   Using FP     Using FP     0.653  0.609  0.694  0.288  0.337 
10 DRC - Kinshasa Pregnant     Pregnant     0.0367 0.0140 0.0930 0.0552 0.0533
# … with 44 more rows</code></pre>
<div class="page-break-after"></div>
<p>Now, we can simply <a href="https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/paste">paste</a> these values together with the original labels from <code>FPSTATUS_1</code> and <code>FPSTATUS_2</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>status_tbl <span class="sc">%&gt;%</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">paste0</span>(scales<span class="sc">::</span><span class="fu">percent</span>(cols, <span class="dv">1</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, FPSTATUS_1) <span class="sc">%&gt;%</span> as_factor, </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">paste0</span>(scales<span class="sc">::</span><span class="fu">percent</span>(rows, <span class="dv">1</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, FPSTATUS_2) <span class="sc">%&gt;%</span> as_factor</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> FPSTATUS_1, <span class="at">alpha =</span> coef)) <span class="sc">+</span> </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(coef, <span class="dv">1</span>),</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> coef <span class="sc">&gt;</span> <span class="fl">0.5</span> <span class="sc">&amp;</span> FPSTATUS_1 <span class="sc">==</span> <span class="st">&quot;Not Using FP&quot;</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span> </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>POP, <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>) <span class="sc">+</span> </span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pma_heatmap</span>(</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;CHANGE IN CONTRACEPTIVE USE OR NON-USE&quot;</span>,</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Percent women age 15-49 who changed contraceptive use status&quot;</span>,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">xaxis =</span> <span class="st">&quot;Phase 1 Status&quot;</span>,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">yaxis =</span> <span class="st">&quot;Phase 2 Status&quot;</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="test_files/figure-html/unnamed-chunk-12-1.png" width="1152" style="display: block; margin: auto;" /></p>
<div class="page-break-after"></div>
<p>The information contained in our heatmap is similar to what we saw in our bar chart, except for two things:</p>
<ol style="list-style-type: decimal">
<li>There are no error bars on our heatmap. If we wanted to include information about the confidence interval for each estimation, we would have to include <a href="https://search.r-project.org/CRAN/refmans/gtools/html/stars.pval.html">text symbols</a>.</li>
<li>While both plots show information about the conditional distribution of <code>FPSTATUS_2</code> given a starting point in <code>FPSTATUS_1</code>, only the heatmap includes the marginal distribution of each variable in its row and column margins.</li>
</ol>
<p>The marginal distribution may provide crucial information about the conditional distribution that we would otherwise miss. Consider Burkina Faso, where both users and non-users of family planning at Phase 1 were generally most likely to maintain their status at Phase 2. The marginal distribution adds additional information: non-users comprise a larger share of the overall population at Phase 1.</p>
<p>In certain contexts, you may want to combine information from the Phase 1 marginal distribution together with the conditional distribution of outcomes at Phase 2. To continue with our example from Burkina Faso, you might report that - because
non-users represent about 62% of the population, only about 11% of the population adopted family planning at Phase 2 following non-use at Phase 1. That is: 18% of 62% is 11%.</p>
<p>In contrast with the conditional distribution, this type of distribution describes the share of the population that experiences some combination of Phase 1 and Phase 2 outcomes <em>without</em> assuming a particular starting point at Phase 1. It’s known as a <strong>joint distribution</strong> because it gives the probability that two events will happen together (in sequence). Let’s return to our summary table, <code>status_tbl</code>: to find the estimated joint distribution for each combination of <code>FPSTATUS_1</code> and <code>FPSTATUS_2</code>, you could simply multiply each value in <code>cols</code> by the value in <code>coef</code>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>status_tbl <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">joint =</span> cols <span class="sc">*</span> coef)</span></code></pre></div>
<pre><code># A tibble: 54 × 9
# Groups:   POP [6]
   POP            FPSTATUS_1   FPSTATUS_2     coef `_low` `_upp`   cols   rows   joint
   &lt;chr&gt;          &lt;fct&gt;        &lt;fct&gt;         &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
 1 Burkina Faso   Pregnant     Pregnant     0.0302 0.0137 0.0652 0.0879 0.0799 0.00266
 2 Burkina Faso   Pregnant     Not Using FP 0.568  0.491  0.642  0.0879 0.583  0.0499 
 3 Burkina Faso   Pregnant     Using FP     0.401  0.329  0.478  0.0879 0.337  0.0353 
 4 Burkina Faso   Not Using FP Pregnant     0.0779 0.0651 0.0929 0.624  0.0799 0.0486 
 5 Burkina Faso   Not Using FP Not Using FP 0.739  0.711  0.765  0.624  0.583  0.461  
 6 Burkina Faso   Not Using FP Using FP     0.183  0.158  0.211  0.624  0.337  0.114  
 7 Burkina Faso   Using FP     Pregnant     0.0993 0.0815 0.121  0.288  0.0799 0.0286 
 8 Burkina Faso   Using FP     Not Using FP 0.248  0.213  0.287  0.288  0.583  0.0713 
 9 Burkina Faso   Using FP     Using FP     0.653  0.609  0.694  0.288  0.337  0.188  
10 DRC - Kinshasa Pregnant     Pregnant     0.0367 0.0140 0.0930 0.0552 0.0533 0.00203
# … with 44 more rows</code></pre>
<div class="page-break-after"></div>
<p>In practice, you’ll usually want to let <a href="http://gdfe.co/srvyr">srvyr</a> calculate a confidence interval for each joint probability. To do so, we’ll add an <a href="http://gdfe.co/srvyr/reference/interact.html">interact</a> function listing the variables in <a href="http://gdfe.co/srvyr/reference/group_by.html">group_by</a> that we want to model jointly.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>joint_tbl <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(POP) <span class="sc">%&gt;%</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">&quot;keep&quot;</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cur_data</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as_survey_design</span>(<span class="at">weight =</span> PANELWEIGHT, <span class="at">id =</span> EAID_1, <span class="at">strata =</span> STRATA_RECODE) <span class="sc">%&gt;%</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(<span class="fu">interact</span>(FPSTATUS_1, FPSTATUS_2)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">joint =</span> <span class="fu">survey_mean</span>(<span class="at">prop =</span> <span class="cn">TRUE</span>, <span class="at">prop_method =</span> <span class="st">&quot;logit&quot;</span>, <span class="at">vartype =</span> <span class="st">&quot;ci&quot;</span>))</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>joint_tbl</span></code></pre></div>
<pre><code># A tibble: 54 × 6
# Groups:   POP [6]
   POP            FPSTATUS_1   FPSTATUS_2     joint joint_low joint_upp
   &lt;chr&gt;          &lt;fct&gt;        &lt;fct&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
 1 Burkina Faso   Pregnant     Pregnant     0.00266  0.00120    0.00587
 2 Burkina Faso   Pregnant     Not Using FP 0.0499   0.0404     0.0615 
 3 Burkina Faso   Pregnant     Using FP     0.0353   0.0291     0.0427 
 4 Burkina Faso   Not Using FP Pregnant     0.0486   0.0402     0.0588 
 5 Burkina Faso   Not Using FP Not Using FP 0.461    0.428      0.495  
 6 Burkina Faso   Not Using FP Using FP     0.114    0.100      0.130  
 7 Burkina Faso   Using FP     Pregnant     0.0286   0.0228     0.0357 
 8 Burkina Faso   Using FP     Not Using FP 0.0713   0.0613     0.0829 
 9 Burkina Faso   Using FP     Using FP     0.188    0.164      0.214  
10 DRC - Kinshasa Pregnant     Pregnant     0.00203  0.000794   0.00515
# … with 44 more rows</code></pre>
<p>Now, the values in <code>joint</code> sum to <code>1.0</code> for each <code>POP</code>. Returning to our heatmap, we’ll want to use the same color for all columns, indicating that the percentages sum for 100% for each population.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>joint_tbl <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> FPSTATUS_1, <span class="at">y =</span> FPSTATUS_2)) <span class="sc">+</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> joint), <span class="at">fill =</span> <span class="st">&quot;#98579B&quot;</span>) <span class="sc">+</span> </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(joint, <span class="dv">1</span>),</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> joint <span class="sc">&gt;</span> <span class="fl">0.5</span> <span class="sc">&amp;</span> FPSTATUS_1 <span class="sc">==</span> <span class="st">&quot;Not Using FP&quot;</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span> </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>POP, <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">scales =</span> <span class="st">&quot;fixed&quot;</span>) <span class="sc">+</span> </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pma_heatmap</span>(</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;CHANGE IN CONTRACEPTIVE USE OR NON-USE&quot;</span>,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Percent women age 15-49 who changed contraceptive use status&quot;</span>,</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">xaxis =</span> <span class="st">&quot;Phase 1 Status&quot;</span>,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">yaxis =</span> <span class="st">&quot;Phase 2 Status&quot;</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  ) </span></code></pre></div>
<p><img src="test_files/figure-html/unnamed-chunk-15-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p>Information provided by the joint distribution nuances our story a bit further. To continue with our examination of Burkina Faso: we knew that family planning users and non-users at Phase 1 were each most likely to maintain, rather than switch their status at Phase 2. However, it’s now clear that <em>continuous non-users</em> (non-users at both Phase 1 and Phase 2) represent a near-majority of the population.</p>
</div>
<div id="alluvial-plots" class="section level2" number="1.4">
<h2><span class="header-section-number">1.4</span> Alluvial plots</h2>
<p><strong>Alluvial plots</strong> are an especially popular way to visualize longitudinal data, in part, because they combine information from each of the three distributions we’ve discussed. They also make it possible to show data from more than two variables (we’ll use them again when Phase 3 data become available). You’ll find alluvial plots on the first two pages of the PMA report for each sample.</p>
<p>In an alluvial plot, the marginal distribution of responses for each variable are usually plotted in vertical stacks. The <a href="https://corybrunson.github.io/ggalluvial/index.html">ggalluvial</a> package authors refer to these stacks as “strata”, and they may be layered onto a <a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a> with <a href="https://corybrunson.github.io/ggalluvial/reference/geom_stratum.html">geom_stratum</a>. In our case, the strata will show the marginal distribution of women in <code>FPSTATUS_1</code> and <code>FPSTATUS_2</code>.</p>
<p>The <strong>joint distribution</strong> for any pair of variables is plotted in horizontal splines called “alluvia”, which bridge the space between any given pair of strata. Alluvia are plotted with <a href="https://corybrunson.github.io/ggalluvial/reference/geom_flow.html">geom_flow</a>.</p>
<p>Finally, we’ll use color to map each alluvium with an originating stratum from <code>FPSTATUS_1</code>. This will help the reader visualize the conditional distribution of <code>FPSTATUS_2</code> responses given a starting point in <code>FPSTATUS_1</code>.</p>
<p>To begin, let’s revisit <code>joint_tbl</code>, which only contains the joint distribution for <code>FPSTATUS_1</code> and <code>FPSTATUS_2</code>. In fact, <a href="https://corybrunson.github.io/ggalluvial/index.html">ggalluvial</a> will calculate the marginal distribution for both variables automatically if we reshape <code>joint_tbl</code> with <a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a> like so:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>joint_tbl <span class="ot">&lt;-</span> joint_tbl <span class="sc">%&gt;%</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowid_to_column</span>(<span class="st">&quot;alluvium&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(FPSTATUS_1, FPSTATUS_2), <span class="at">names_to =</span> <span class="st">&quot;x&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;stratum&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">x =</span> <span class="fu">ifelse</span>(x <span class="sc">==</span> <span class="st">&quot;FPSTATUS_1&quot;</span>, <span class="st">&quot;Phase 1&quot;</span>, <span class="st">&quot;Phase 2&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(x, alluvium)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>joint_tbl</span></code></pre></div>
<pre><code># A tibble: 108 × 7
# Groups:   POP [6]
   alluvium POP              joint joint_low joint_upp x       stratum     
      &lt;int&gt; &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;   &lt;fct&gt;       
 1        1 Burkina Faso   0.00266  0.00120    0.00587 Phase 1 Pregnant    
 2        2 Burkina Faso   0.0499   0.0404     0.0615  Phase 1 Pregnant    
 3        3 Burkina Faso   0.0353   0.0291     0.0427  Phase 1 Pregnant    
 4        4 Burkina Faso   0.0486   0.0402     0.0588  Phase 1 Not Using FP
 5        5 Burkina Faso   0.461    0.428      0.495   Phase 1 Not Using FP
 6        6 Burkina Faso   0.114    0.100      0.130   Phase 1 Not Using FP
 7        7 Burkina Faso   0.0286   0.0228     0.0357  Phase 1 Using FP    
 8        8 Burkina Faso   0.0713   0.0613     0.0829  Phase 1 Using FP    
 9        9 Burkina Faso   0.188    0.164      0.214   Phase 1 Using FP    
10       10 DRC - Kinshasa 0.00203  0.000794   0.00515 Phase 1 Pregnant    
# … with 98 more rows</code></pre>
<p>Here, we create the column <code>alluvium</code> to hold the original row number for each of the 56 combinations of <code>POP</code>, <code>FPSTATUS_1</code>, and <code>FPSTATUS_2</code>. When we <a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a>, we repeat the value in <code>joint</code> once for each end of the same <code>alluvium</code>. The values in <code>stratum</code> describe the strata to to which each alluvium is attached, and <code>x</code> indicates whether the stratum is located in the Phase 1 or Phase 2 stack.</p>
<aside>
For consistency, <code>pma_alluvial</code> uses the same color scheme shown in the first alluvial plot in each PMA report.
</aside>
<p>As with our heatmap, we’ll want to define some custom fonts, color, and layout options in a function we’ll call <code>pma_alluvial</code>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>pma_alluvial <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="cn">NULL</span>,     <span class="co"># an optional title </span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="cn">NULL</span>,  <span class="co"># an optional subtitle </span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">xaxis =</span> <span class="cn">NULL</span>,     <span class="co"># an optional label for the x-axis (displayed below)</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">yaxis =</span> <span class="cn">NULL</span>      <span class="co"># an optional label for the y-axis (displayed left)</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>){</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  components <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">%+replace%</span> <span class="fu">theme</span>(</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">family =</span> <span class="st">&quot;cabrito&quot;</span>, <span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">22</span>, <span class="at">color =</span> <span class="st">&quot;#541E5A&quot;</span>, </span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>                                <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">mar =</span> <span class="fu">margin</span>(<span class="at">b =</span> <span class="dv">5</span>)),</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">b =</span> <span class="dv">20</span>)),</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">strip.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>, <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">b =</span> <span class="dv">5</span>)),</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;#541E5A&quot;</span>, <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">5</span>, <span class="at">b =</span> <span class="dv">10</span>)),</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.spacing =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">&quot;lines&quot;</span>),</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="dv">0</span>, <span class="dv">100</span>),</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>,</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.spacing.x =</span> <span class="fu">unit</span>(<span class="dv">10</span>, <span class="st">&quot;pt&quot;</span>),</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> title,</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> subtitle,</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> xaxis,</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">str_wrap</span>(yaxis, <span class="dv">10</span>),</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;Pregnant&quot;</span> <span class="ot">=</span> <span class="st">&quot;#B4B3B3&quot;</span>, </span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;Not Using FP&quot;</span> <span class="ot">=</span> <span class="st">&quot;#4E4F71&quot;</span>, </span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;Using FP&quot;</span> <span class="ot">=</span> <span class="st">&quot;#EFD372&quot;</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    )),</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="page-break-after"></div>
<p>We’ll start by mapping common aesthetics in a <a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a> function. We’ll map the values in <code>x</code> onto our x-axis, and we’ll map the values in <code>joint</code> onto the y-axis. The remaining aesthetics are specific to the functions from <a href="https://corybrunson.github.io/ggalluvial/index.html">ggalluvial</a>: we’ll use <code>stratum</code> to build vertical strata and to define colors mapped with “fill”. We also use the identifying numbers in <code>alluvium</code> to organize responses into alluvia.</p>
<p>The remaining functions are straightforward, since they mainly use information passed from <a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a>. We make only one small modification to <a href="https://corybrunson.github.io/ggalluvial/reference/geom_stratum.html">geom_stratum</a>: setting <code>size = 0</code> removes border lines that appear around each stratum, by default.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>status_alluvial <span class="ot">&lt;-</span> joint_tbl <span class="sc">%&gt;%</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> x, </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> joint,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> stratum,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">stratum =</span> stratum,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">alluvium =</span> alluvium</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span> </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_flow</span>() <span class="sc">+</span> </span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stratum</span>(<span class="at">size =</span> <span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>POP, <span class="at">scales =</span> <span class="st">&quot;free_x&quot;</span>, <span class="at">nrow =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pma_alluvial</span>(</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;CHANGE IN CONTRACEPTIVE USE OR NON-USE&quot;</span>,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Percent women age 15-49 who changed contraceptive use status&quot;</span>,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>status_alluvial</span></code></pre></div>
<p><img src="test_files/figure-html/unnamed-chunk-18-1.png" width="1728" style="display: block; margin: auto;" /></p>
<div class="page-break-after"></div>
<p>Of course, you should always include either y-axis gridlines or text labels for the probabilities shown on a plot like this one. We find it clearer to include the latter, which we’ll build with <a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a>.</p>
<aside>
Values may not add to 100% due to rounding (values rounded to 0% are not labelled).
</aside>
<p>These labels are a bit tricky, but the basic idea is that you use <code>stat = "stratum"</code> to label strata, and <code>stat = "flow"</code> to label alluvia. Then, you use <a href="https://ggplot2.tidyverse.org/reference/aes_eval.html">after_stat</a> to build labels from statistics that <a href="https://corybrunson.github.io/ggalluvial/index.html">ggalluvial</a> uses to construct the plot - check out <a href="https://corybrunson.github.io/ggalluvial/reference/stat_stratum.html#computed-variables">this list</a> of available statistics for details. We’ll use the <code>prop</code> statistic to obtain <em>both</em> the marginal and joint probabilities.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>status_alluvial <span class="sc">+</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">stat =</span> <span class="st">&quot;stratum&quot;</span>,   <span class="co"># label strata</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">ifelse</span>( </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>      x <span class="sc">==</span> <span class="dv">1</span>, <span class="co"># labels the strata for Phase 1, otherwise blank &quot;&quot;           </span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>      scales<span class="sc">::</span><span class="fu">percent</span>(<span class="fu">after_stat</span>(prop), <span class="dv">1</span>), </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;&quot;</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    )),</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_x =</span> <span class="sc">-</span><span class="fl">0.2</span>,  <span class="co"># nudge a bit to the left </span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="st">&quot;right&quot;</span>, <span class="co"># right-justify</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">stat =</span> <span class="st">&quot;stratum&quot;</span>, <span class="co"># label strata</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">ifelse</span>(</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>      x <span class="sc">==</span> <span class="dv">2</span>, <span class="co"># labels the strata for Phase 2, otherwise blank &quot;&quot;    </span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>      scales<span class="sc">::</span><span class="fu">percent</span>(<span class="fu">after_stat</span>(prop), <span class="dv">1</span>), </span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;&quot;</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    )),</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_x =</span> <span class="fl">0.2</span>,  <span class="co"># nudge a bit to the right </span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="st">&quot;left&quot;</span>, <span class="co"># left-justify</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">stat =</span> <span class="st">&quot;flow&quot;</span>,   <span class="co"># label alluvia </span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">ifelse</span>( </span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">after_stat</span>(flow) <span class="sc">==</span> <span class="st">&quot;to&quot;</span> <span class="sc">&amp;</span>  <span class="co"># only label the destination (right-side)</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        <span class="fu">after_stat</span>(prop) <span class="sc">&gt;=</span> <span class="fl">0.01</span>, <span class="co"># hide if 0%</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>      scales<span class="sc">::</span><span class="fu">percent</span>(<span class="fu">after_stat</span>(prop), <span class="dv">1</span>), </span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;&quot;</span> </span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    )),</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_x =</span> <span class="sc">-</span><span class="fl">0.2</span>,  <span class="co"># nudge a bit to the left</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="st">&quot;right&quot;</span>, <span class="co"># right-justify</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span>         <span class="co"># use a slightly smaller font </span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>  ) </span></code></pre></div>
<p>Now, it’s easy to identify the proportion of women at each phase <em>and</em> the proportion who switched or maintained their status between phases. If possible, we recommend aligning alluvial plots for every sample in a single row as shown: this allows the readers to visually compare the relative size of strata and alluvia across samples.</p>
<div class="page-break-after"></div>
<p><img src="images/alluvial.png" width="90%" style="display: block; margin: auto;" /></p>
</div>
</div>
</div>



<script>
// when the page is about to reload via servr, remember the scroll position
document.addEventListener('servr:reload', function(e) {
  sessionStorage.setItem('pagedown-scroll', window.scrollY);
});
</script>
</body>
</html>
